import Foundationimport SwiftUIimport CoreData@MainActorclass ProfileViewModel: ObservableObject {    @Published var profiles: [Profile] = []    @Published var selectedProfileIndex: Int = 0 {        didSet {            saveSelectedProfileIndex()        }    }    private let profilesKey = "profiles.json"    private let selectedIndexKey = "selectedProfileIndex"    init() {        loadProfiles()    }    var selectedProfile: Profile {        if profiles.isEmpty {            let defaultProfile = Profile(name: "Grandparent", photoData: nil)            profiles.append(defaultProfile)            selectedProfileIndex = 0            saveProfiles()        }        if !profiles.indices.contains(selectedProfileIndex) {            selectedProfileIndex = 0        }        return profiles[selectedProfileIndex]    }    var canCreateNewProfile: Bool {        let subscriptionManager = RCSubscriptionManager.shared                if subscriptionManager.hasActiveSubscription {            return true        }                return profiles.count < 1    }        var profileLimitMessage: String {        let subscriptionManager = RCSubscriptionManager.shared                if subscriptionManager.hasActiveSubscription {            return "Unlimited profiles available"        }                if profiles.count >= 1 {            return "Subscribe to create multiple profiles"        }                return "You can create 1 free profile"    }    func addProfile(_ profile: Profile) -> Bool {        guard canCreateNewProfile else {            print("âŒ Profile creation blocked - subscription required for multiple profiles")            return false        }                profiles.append(profile)        selectedProfileIndex = profiles.count - 1        saveProfiles()                print("âœ… Profile added successfully. Total profiles: \(profiles.count)")        return true    }    func deleteSelectedProfile() {        guard profiles.indices.contains(selectedProfileIndex) else { return }                guard profiles.count > 1 else {            print("âŒ Cannot delete the last profile")            return        }                profiles.remove(at: selectedProfileIndex)        selectedProfileIndex = max(0, selectedProfileIndex - 1)        saveProfiles()    }    func updateSelectedProfile(with newProfile: Profile) {        guard profiles.indices.contains(selectedProfileIndex) else { return }        profiles[selectedProfileIndex] = newProfile        saveProfiles()    }    func updateName(for profile: Profile, to newName: String) {        guard let index = profiles.firstIndex(of: profile) else { return }        profiles[index].name = newName        saveProfiles()    }    func removePhotoFromSelectedProfile() {        guard profiles.indices.contains(selectedProfileIndex) else { return }        profiles[selectedProfileIndex].photoData = nil        saveProfiles()    }    func selectPreviousProfile() {        guard !profiles.isEmpty else { return }        selectedProfileIndex = (selectedProfileIndex - 1 + profiles.count) % profiles.count    }    func selectNextProfile() {        guard !profiles.isEmpty else { return }        selectedProfileIndex = (selectedProfileIndex + 1) % profiles.count    }    private func getDocumentsDirectory() -> URL {        FileManager.default.urls(for: .documentDirectory, in: .userDomainMask).first!    }    private func saveProfiles() {        let url = getDocumentsDirectory().appendingPathComponent(profilesKey)        if let data = try? JSONEncoder().encode(profiles) {            try? data.write(to: url)                        NSUbiquitousKeyValueStore.default.set(data, forKey: "memoir_profiles_backup")            NSUbiquitousKeyValueStore.default.synchronize()        }    }    private func loadProfiles() {        let url = getDocumentsDirectory().appendingPathComponent(profilesKey)        var loadedProfiles: [Profile] = []                if let data = try? Data(contentsOf: url),           let decoded = try? JSONDecoder().decode([Profile].self, from: data) {            loadedProfiles = decoded        }        else if let backupData = NSUbiquitousKeyValueStore.default.data(forKey: "memoir_profiles_backup"),                let decoded = try? JSONDecoder().decode([Profile].self, from: backupData) {            loadedProfiles = decoded            print("ðŸ”„ Restored profiles from iCloud backup")                        try? backupData.write(to: url)        }                self.profiles = loadedProfiles        if profiles.isEmpty {            let defaultProfile = Profile(name: "Grandparent", photoData: nil)            profiles.append(defaultProfile)            selectedProfileIndex = 0            saveProfiles()        }        let savedIndex = UserDefaults.standard.integer(forKey: selectedIndexKey)        selectedProfileIndex = min(savedIndex, max(0, profiles.count - 1))    }    private func saveSelectedProfileIndex() {        UserDefaults.standard.set(selectedProfileIndex, forKey: selectedIndexKey)    }}